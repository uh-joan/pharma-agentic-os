# Pharmaceutical Research Intelligence Platform

## Core Execution Principle

**CODE-FIRST ARCHITECTURE**:
- Agents generate **executable Python scripts**, NOT markdown analysis
- Claude Code saves scripts to `scripts/[domain]/` and executes via `python3 script.py`
- Scripts contain MCP queries, business logic, and output formatting
- Results saved to `data_dump/` for raw data, `temp/` for analysis outputs
- Direct MCP calls ONLY for exploration (understanding response structure)

**Why Code-First**:
- ✅ Reproducible (scripts can be re-run)
- ✅ Testable (scripts can be unit tested)
- ✅ Versionable (scripts in git)
- ✅ Composable (scripts import shared functions)
- ✅ Token-efficient (execution happens outside conversation)

## Agent Types

### 1. Code-Generating Specialists
**Pattern**: User query → Agent generates Python script → Claude Code saves to `scripts/` → Executes script

**Agents**:
- `competitive-specialist` → `scripts/competitive/[condition]_analysis.py`
- `pharma-search-specialist` → `scripts/mcp/queries/[query_type].py` (future migration)

**Output**: Executable `.py` files with:
- MCP query calls (using MCP tools directly in Python)
- Data processing logic
- Structured output (console + optionally save to data_dump/)

**Invocation**:
```
@agent-competitive-specialist [query]
→ Agent reads .claude/agents/competitive-specialist.md
→ Generates Python script
→ Claude Code saves to scripts/competitive/nash/nash_phase3.py
→ Claude Code executes: python3 scripts/competitive/nash/nash_phase3.py
→ Output shown to user
```

### 2. Planning Agents (Legacy - To Be Migrated)
**Current Pattern**: User query → Agent generates JSON plan → Claude Code executes MCP queries

**Agents**:
- `pharma-search-specialist` (currently JSON, migrate to code-generating)
- `search-orchestrator` (project-level orchestration)

**Status**: These will be migrated to code-generating pattern over time.

### 3. Read-Only Analytical Agents (Legacy - To Be Evaluated)
**Pattern**: Reads existing files (data_dump/, temp/) → Outputs markdown analysis

**Agents**: All `-analyst`, `-modeler`, `-synthesizer`, `-strategist` agents

**Status**: Evaluate if these should also generate Python scripts for reproducible analysis.

## Script Organization

```
scripts/
├── competitive/           # Competitive intelligence scripts
│   ├── nash/
│   │   └── nash_phase3_competitive.py
│   ├── obesity/
│   │   └── obesity_landscape.py
│   └── [condition]/
│       └── [analysis_type].py
├── mcp/                   # MCP query utilities
│   ├── queries/           # Query helper functions (future)
│   ├── client.py          # MCP client wrapper
│   └── servers/           # Server-specific utilities
├── analysis/              # Analysis modules
│   └── modules/
│       └── competitive.py # Atomic analysis functions
└── utils/                 # Utilities
    └── fda_query_validator.py
```

## Workflow: Code-Generating Specialist

**Example**: User asks "Who's in Phase 3 for NASH and when do they launch?"

### Step 1: Invoke Agent
```
@agent-competitive-specialist Who's in Phase 3 for NASH and when do they launch?
```

### Step 2: Agent Generates Script
Agent reads `.claude/agents/competitive-specialist.md` and generates:

```python
#!/usr/bin/env python3
"""
NASH Phase 3 Competitive Analysis
Generated by: competitive-specialist
"""
import json
from datetime import datetime

def main():
    # Query execution logic here
    # MCP calls embedded in script
    # Data processing
    # Structured output

    print("=" * 100)
    print("NASH PHASE 3 COMPETITIVE ANALYSIS")
    print("=" * 100)
    # ... analysis output ...

if __name__ == '__main__':
    main()
```

### Step 3: Claude Code Saves Script
```
scripts/competitive/nash/nash_phase3_competitive.py
```

### Step 4: Claude Code Executes
```bash
python3 scripts/competitive/nash/nash_phase3_competitive.py
```

### Step 5: Output to User
Console output shown to user. Optionally save structured data to `data_dump/`.

## MCP Query Execution Rules

### ✅ WHEN TO USE DIRECT MCP CALLS (Rare)
**Only for exploration/understanding**:
- Testing MCP tool response structure
- Validating query syntax
- One-off data lookups during development
- Understanding field names/formats

**Example**:
```
"Let me check the CT.gov API response format first..."
→ Direct MCP call to see structure
→ Then generate script based on understanding
```

### ❌ WHEN TO GENERATE SCRIPTS INSTEAD (Default)
**For all analytical work**:
- Competitive analysis
- Market sizing
- Pipeline assessment
- Any query that produces analysis/insights
- Anything the user might want to reproduce

**Example**:
```
"Who's in Phase 3 for NASH?"
→ Generate script that queries CT.gov
→ Script processes results
→ Script outputs structured analysis
```

## File Persistence

### Scripts (`scripts/`)
- **Saved by**: Claude Code (after agent generates code)
- **Contains**: Executable Python with MCP queries + analysis logic
- **Naming**: `scripts/[domain]/[topic]/[analysis_type].py`
- **Version control**: Yes (commit to git)

### Raw Data (`data_dump/`)
- **Saved by**: Scripts (optional output destination)
- **Contains**: Raw JSON from MCP queries
- **Naming**: `data_dump/YYYY-MM-DD_HHMMSS_[source]_[query]/`
- **Version control**: No (.gitignore)

### Analysis Outputs (`temp/`)
- **Saved by**: Claude Code (after read-only agents produce markdown)
- **Contains**: Markdown analysis from read-only agents
- **Naming**: `temp/[analysis_type]_YYYY-MM-DD_HHMMSS_[topic].md`
- **Version control**: No (.gitignore)

## Migration Path

### Phase 1: Current (Nov 2025)
- ✅ `competitive-specialist`: Code-generating (complete)
- ⏳ `pharma-search-specialist`: JSON plans (legacy)
- ⏳ All analytical agents: Read-only markdown (legacy)

### Phase 2: Near-term
- Migrate `pharma-search-specialist` to code-generating
- Create template for other specialists

### Phase 3: Long-term
- Evaluate analytical agents for code-generation pattern
- Build shared analysis function libraries
- Create agent composition patterns

## Agent Invocation Templates

### For Code-Generating Specialists

**competitive-specialist**:
```
@agent-competitive-specialist [query about competitive landscape]

Example: "Who's in Phase 3 for NASH and when do they launch?"

→ Generates Python script with:
  1. CT.gov queries for Phase 3 programs
  2. Sponsor/mechanism analysis
  3. Launch timeline estimates
  4. Threat scoring
  5. Strategic recommendations

→ Claude Code saves to scripts/competitive/nash/
→ Claude Code executes script
→ Structured analysis output to console
```

### For Planning Agents (Legacy)

**pharma-search-specialist**:
```
You are pharma-search-specialist. Read .claude/agents/pharma-search-specialist.md.

Query: '[user query]'

Read relevant tool guide from .claude/.context/mcp-tool-guides/
Return ONLY JSON execution plan.
```

**search-orchestrator**:
```
You are search-orchestrator. Read .claude/agents/search-orchestrator.md.

Analyze project context files and create workflow plan with:
1. mcp_queries: Data gathering tasks
2. specialist_delegations: Analysis tasks
3. synthesis_plan: Final compilation

Return ONLY JSON plan.
```

### For Read-Only Analysts (Legacy)

**Example - epidemiology-analyst**:
```
You are epidemiology-analyst. Read .claude/agents/epidemiology-analyst.md.

Analyze data_dump/[folder]/ and return:
- Prevalence model
- Patient segmentation
- Eligibility funnel

Output: Markdown analysis
```

## MCP Servers

Available MCP servers (see `.mcp.json`):
- `ct-gov-mcp`: ClinicalTrials.gov trial data
- `pubmed-mcp`: PubMed literature
- `fda-mcp`: FDA drug labels, adverse events, recalls
- `nlm-codes-mcp`: ICD-10, ICD-11, HCPCS, NPI coding
- `who-mcp-server`: WHO health statistics
- `sec-mcp-server`: SEC financial filings
- `healthcare-mcp`: CMS Medicare data
- `financials-mcp-server`: Yahoo Finance, FRED economic data
- `datacommons-mcp`: Population/disease statistics
- `patents-mcp-server`: USPTO patent search
- `opentargets-mcp-server`: Target validation, genetics
- `pubchem-mcp-server`: Compound properties, ADME

**Tool guides**: `.claude/.context/mcp-tool-guides/` (clinicaltrials.md, fda.md, etc.)

## FDA Query Optimization

**All FDA queries must include count parameter** to avoid 25k token MCP limit.

Auto-validation via `scripts/utils/fda_query_validator.py`:
- Adds count parameter if missing
- Adds .exact suffix to count fields
- Validates field selection

**See**: `scripts/utils/README.md`

## Token Efficiency

**Critical**: Task tool calls carry full conversation history (~50k tokens).

**Best Practices**:
1. Generate scripts instead of JSON plans (execution happens outside conversation)
2. Keep agent prompts minimal
3. Use count/pagination in MCP queries (max 50-100 records)
4. Scripts handle large data processing efficiently

## Design Principles

1. **Code-First**: All agents generate executable Python, not markdown
2. **Reproducible**: Scripts can be re-run without re-invoking agent
3. **Testable**: Scripts can be unit tested and validated
4. **Composable**: Scripts import shared analysis functions
5. **Token-Efficient**: Execution happens outside conversation context
6. **Version-Controlled**: Scripts committed to git, outputs ignored

## Examples

### Example 1: Competitive Analysis
```
User: "Analyze competitive landscape for obesity drugs"

Claude Code: Invokes competitive-specialist agent
Agent: Generates scripts/competitive/obesity/obesity_landscape.py
Claude Code: Saves script to scripts/competitive/obesity/
Claude Code: Executes python3 scripts/competitive/obesity/obesity_landscape.py

Output:
====================================================================================================
OBESITY COMPETITIVE LANDSCAPE ANALYSIS
====================================================================================================

## Executive Summary
- Total US Trials: 5,665
- Phase 3 Active: 90 programs
- Competitive Intensity: EXTREMELY INTENSE (1595/1000)
- GLP-1 Dominance: 88 active trials (2.9%)
...
```

### Example 2: Exploratory MCP Call
```
User: "What fields are available in CT.gov API?"

Claude Code: Makes direct MCP call to understand structure
(Shows sample response with field names)

User: "Now analyze Phase 3 NASH programs"

Claude Code: Invokes competitive-specialist to generate script
(Generates script based on field understanding from exploration)
```

## Current Agents

### Code-Generating Specialists (✅ Complete)
- `competitive-specialist`: Competitive intelligence analysis scripts

### Planning Agents (⏳ Legacy - To Migrate)
- `pharma-search-specialist`: Data gathering JSON plans
- `search-orchestrator`: Multi-phase project JSON plans

### Read-Only Analysts (⏳ Legacy - To Evaluate)
All `-analyst`, `-modeler`, `-synthesizer`, `-strategist` agents:
- epidemiology-analyst
- patient-flow-modeler
- uptake-dynamics-analyst
- pricing-strategy-analyst
- revenue-synthesizer
- market-sizing-analyst
- opportunity-identifier
- strategy-synthesizer
- comparable-analyst
- npv-modeler
- structure-optimizer
- target-identifier
- target-validator
- target-druggability-assessor
- target-hypothesis-synthesizer
- safety-pharmacology-analyst
- genetic-toxicology-analyst
- toxicology-analyst
- toxicologist-regulatory-strategist
- rwe-study-designer
- rwe-outcomes-analyst
- rwe-analytics-strategist
- regulatory-risk-analyst
- regulatory-precedent-analyst
- regulatory-pathway-analyst
- regulatory-label-strategist
- regulatory-adcomm-strategist

**Status**: Current read-only pattern. Evaluate for code-generation migration.

## Next Steps

1. **Immediate**: Use competitive-specialist as reference for code-first pattern
2. **Short-term**: Migrate pharma-search-specialist to code-generating
3. **Medium-term**: Evaluate analytical agents for code-generation pattern
4. **Long-term**: Build comprehensive script library with shared analysis functions

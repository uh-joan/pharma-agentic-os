# Pharmaceutical Research Intelligence Platform

## Core Architecture

**Multi-Agent Pattern**: Planning agents + Analytical agents + Manual utility scripts

**Execution Patterns**:

1. **Planning Agents** (pharma-search-specialist, search-orchestrator)
   - Generate JSON execution plans
   - Claude Code executes MCP queries directly
   - Results saved to `data_dump/`

2. **Analytical Agents** (all -analyst/-modeler/-synthesizer agents)
   - Read existing data from `data_dump/` and `temp/`
   - Generate markdown analysis
   - Claude Code saves to `temp/`

3. **Manual Utility Scripts** (`scripts/` folder)
   - Pre-written Python scripts for MCP operations
   - Can be run directly: `python3 scripts/[path]/[script].py`
   - NOT generated by agents (manually maintained)

**Design Benefits**:
- ✅ Clear separation of concerns (planning vs analysis vs utilities)
- ✅ Reproducible (manual scripts in git, can be re-run)
- ✅ Token-efficient (agents produce JSON/markdown, not code)
- ✅ Maintainable (scripts versioned, tested separately)

## pharma-search-specialist Agent

**Defined in**: `.claude/agents/pharma-search-specialist.md`

**Pattern**: User query → JSON execution plan → Claude Code executes MCP queries

**How it works**:
1. User provides query (e.g., "Find Phase 3 NASH trials")
2. Agent analyzes query and reads MCP tool guides
3. Agent returns JSON execution plan:
   ```json
   {
     "execution_plan": [
       {
         "step": 1,
         "tool": "mcp__ct-gov-mcp__ct_gov_studies",
         "method": "search",
         "params": {"condition": "NASH", "phase": "PHASE3"}
       }
     ]
   }
   ```
4. Claude Code executes each step via MCP tools
5. Results saved to `data_dump/YYYY-MM-DD_HHMMSS_[source]_[query]/`

**Use for**: Data gathering, MCP query planning

## scripts/ Folder Organization

**Purpose**: Manual utility scripts for MCP operations and analysis

**Structure**:
```
scripts/
├── analysis/              # Analysis scripts (manually written)
│   ├── obesity/           # Obesity-specific analyses
│   │   ├── obesity_pipeline_analysis.py
│   │   └── obesity_active_pipeline_analysis.py
│   └── modules/           # Shared analysis functions
│       └── competitive.py
├── mcp/                   # MCP utilities
│   ├── client.py          # MCP client wrapper (get_client())
│   ├── queries/           # Query helper functions
│   ├── servers/           # Server-specific utilities
│   ├── examples/          # Example MCP usage scripts
│   └── tests/             # Test suites
└── utils/                 # General utilities
    └── fda_query_validator.py  # Auto-optimizes FDA queries
```

**Key Points**:
- These are **manually maintained** scripts, NOT agent-generated
- Can be executed directly: `python3 scripts/analysis/obesity/obesity_pipeline_analysis.py`
- Import shared utilities via `from mcp.client import get_client`
- Used for reproducible analysis and testing

## File Persistence

### Raw Data (`data_dump/`)
- **Saved by**: Claude Code after executing MCP queries
- **Contains**: Raw JSON from MCP queries
- **Naming**: `data_dump/YYYY-MM-DD_HHMMSS_[source]_[query]/`
- **Version control**: No (.gitignore)

### Analysis Outputs (`temp/`)
- **Saved by**: Claude Code after analytical agents produce markdown
- **Contains**: Markdown analysis from analytical agents
- **Naming**: `temp/[analysis_type]_YYYY-MM-DD_HHMMSS_[topic].md`
- **Version control**: No (.gitignore)

## Workflow Examples

### Example 1: Planning Agent Workflow

**User**: "Find Phase 3 NASH trials"

**Step 1**: Invoke planning agent
```
You are pharma-search-specialist. Read .claude/agents/pharma-search-specialist.md.
Query: 'Find Phase 3 NASH trials'
Return ONLY JSON execution plan.
```

**Step 2**: Agent returns JSON plan
```json
{
  "execution_plan": [
    {
      "step": 1,
      "tool": "mcp__ct-gov-mcp__ct_gov_studies",
      "method": "search",
      "params": {
        "condition": "NASH OR non-alcoholic steatohepatitis",
        "phase": "PHASE3",
        "pageSize": 50
      }
    }
  ]
}
```

**Step 3**: Claude Code executes MCP queries directly
- Calls `mcp__ct-gov-mcp__ct_gov_studies` tool
- Gets results from ClinicalTrials.gov

**Step 4**: Claude Code saves results
- Raw JSON → `data_dump/2025-11-18_143022_ctgov_nash/`

### Example 2: Analytical Agent Workflow

**User**: "Analyze the NASH trial data"

**Step 1**: Invoke analytical agent
```
You are epidemiology-analyst. Read .claude/agents/epidemiology-analyst.md.
Analyze data_dump/2025-11-18_143022_ctgov_nash/ and return epidemiology analysis.
```

**Step 2**: Agent reads files
- Reads `data_dump/2025-11-18_143022_ctgov_nash/results.json`
- Processes data

**Step 3**: Agent returns markdown
```markdown
# NASH Epidemiology Analysis

## Prevalence Model
- Total trials: 97
- Phase 3: 21 active programs
...
```

**Step 4**: Claude Code saves markdown
- Analysis → `temp/epidemiology_analysis_2025-11-18_143500_nash.md`

### Example 3: Manual Script Execution

**User**: "Run the obesity pipeline analysis"

**Step 1**: Claude Code executes pre-existing script
```bash
python3 scripts/analysis/obesity/obesity_pipeline_analysis.py
```

**Step 2**: Script makes MCP calls directly
```python
from mcp.client import get_client

client = get_client('ct-gov-mcp')
result = client.call_tool('ct_gov_studies', {
    'method': 'search',
    'condition': 'obesity',
    'phase': 'PHASE3'
})
```

**Step 3**: Script outputs analysis
- Console output shown to user
- Optionally saves to data_dump/

## MCP Servers

Available MCP servers (see `.mcp.json`):
- `ct-gov-mcp`: ClinicalTrials.gov trial data
- `pubmed-mcp`: PubMed literature
- `fda-mcp`: FDA drug labels, adverse events, recalls
- `nlm-codes-mcp`: ICD-10, ICD-11, HCPCS, NPI coding
- `who-mcp-server`: WHO health statistics
- `sec-mcp-server`: SEC financial filings
- `healthcare-mcp`: CMS Medicare data
- `financials-mcp-server`: Yahoo Finance, FRED economic data
- `datacommons-mcp`: Population/disease statistics
- `patents-mcp-server`: USPTO patent search
- `opentargets-mcp-server`: Target validation, genetics
- `pubchem-mcp-server`: Compound properties, ADME

**Tool guides**: `.claude/.context/mcp-tool-guides/` (clinicaltrials.md, fda.md, etc.)

## FDA Query Optimization

**All FDA queries must include count parameter** to avoid 25k token MCP limit.

Auto-validation via `scripts/utils/fda_query_validator.py`:
- Adds count parameter if missing
- Adds .exact suffix to count fields
- Validates field selection

**See**: `scripts/utils/README.md`

## Token Efficiency

**Critical**: Task tool calls carry full conversation history (~50k tokens).

**Best Practices**:
1. Generate scripts instead of JSON plans (execution happens outside conversation)
2. Keep agent prompts minimal
3. Use count/pagination in MCP queries (max 50-100 records)
4. Scripts handle large data processing efficiently

## Design Principles

1. **Separation of Concerns**: Planning (JSON) vs Analysis (Markdown) vs Utilities (Python scripts)
2. **Planning-Based**: Agents generate JSON execution plans, Claude Code executes MCP queries
3. **Analysis-Based**: Agents read data, generate markdown insights
4. **Manual Scripts**: Reproducible utilities maintained separately from agents
5. **Token-Efficient**: Agents produce simple outputs (JSON/markdown), heavy lifting in scripts/execution
6. **Audit Trail**: Raw data → data_dump/, analysis → temp/, scripts → version controlled

